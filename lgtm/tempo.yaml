auth_enabled: false
target: all

server:
  http_listen_port: 3200
  log_level: info
  log_format: json

distributor:
  receivers:
    otlp:
      protocols:
        http:
          endpoint: "0.0.0.0:4318"
        grpc:
          endpoint: "0.0.0.0:4317"
  max_attribute_bytes: 2048 # default 2KB (attr超過則截斷)

## grpc_compression: snappy - 用 CPU 換取 NetworkTraffic
#     https://grafana.com/docs/tempo/latest/configuration/#grpc-compression
ingester_client:
  grpc_client_config:
    grpc_compression: "snappy"
metrics_generator_client:
  grpc_client_config:
    grpc_compression: "snappy"
querier:
  frontend_worker:
    grpc_client_config:
      grpc_compression: "snappy"
query_frontend:
  search:
    max_duration: 0s

ingester:
  trace_idle_period: 10s
  trace_live_period: 1m
  flush_all_on_shutdown: true # SingleBinary 啟用; MultiNodes 必須關閉

compactor:
  disabled: false
  compaction:
    block_retention: 336h # 14 days - trace 保存期限

storage:
  trace:
    backend: local
    local:
      path: /var/tempo/blocks
    wal:
      path: /var/tempo/wal
# ## Store traces to S3
# storage:
#   trace:
#     backend: s3
#     s3:
#       bucket: tempo-traces
#       region: us-west-2
#       role_arn: arn:aws:iam::123456789012:role/tempo-s3

# https://grafana.com/docs/tempo/latest/configuration/#metrics-generator
metrics_generator:
  registry:
    external_labels:
      source: tempo
  storage:
    path: /var/tempo/generator/wal
    remote_write:
    - url: http://mimir:9009/api/v1/push
      send_exemplars: true
  # local-blocks processor 需要 traces WAL
  traces_storage:
    path: /var/tempo/generator/traces_wal
  processor:
    service_graphs:
      dimensions: []
      histogram_buckets: [ 0.2, 0.5, 2, 5, 10, 15, 30 ]
      # 支援新版 OTel semantic conventions
      peer_attributes:
        - peer.service
      # enable_virtual_node_label: true
    span_metrics:
      histogram_buckets: [ 0.2, 0.5, 2, 5, 10, 15, 30 ]
      dimensions: []
      # # 留意高基數
      # - http.method
      # - http.status_code
      # # - http.host
      # # - http.route
      # # - http.scheme
    local_blocks:
      # TraceQL metrics processor for Grafana Traces Drilldown
      # Generates metrics from trace data for query performance
      complete_block_timeout: 5m
      max_block_duration: 5m
      max_block_bytes: 10485760  # 10MB
      filter_server_spans: false

overrides:
  defaults:
    metrics_generator:
      processors:
        - service-graphs
        - span-metrics
        - local-blocks
