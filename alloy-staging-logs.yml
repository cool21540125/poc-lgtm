// ============================== Posserver ==============================
// Rails - posserver
loki.source.file "stag_pos_log" {
	targets = [
		{
			__path__ = "/var/www/log/staging/log/staging.log",
			app      = "pos", // Code: ISTORE-BE-Pos-Server
			aws      = "ec2",
			env      = "stag",
			team     = "backend",
		},
	]
	forward_to = [loki.process.stag_pos.receiver]
}

// 處理 Rails 日誌
loki.process "stag_pos" {
	stage.regex {
		expression = `^\[(?P<request_id>[^\]]+)\] (?P<message>.*)`
	}

	stage.labels {
		values = {
			request_id = "",
		}
	}

	forward_to = [loki.write.staging_logs.receiver]
}

// ============================== SDB ==============================
// ?? - SDB
loki.source.file "staging_sdb_log" {
	targets = [
		{
			__path__ = "/var/www/log/staging/log/sdb_logger.log",
			app      = "sdb", // TODO: 不確定
			aws      = "ec2",
			env      = "stag",
			team     = "backend",
		},
	]
	forward_to = [loki.process.staging_sdb.receiver]
}

// 處理 SDB 日誌  
loki.process "staging_sdb" {
	stage.regex {
		expression = `^(?P<level>[A-Z]), \[(?P<timestamp>[^\]]+) #(?P<pid>\d+)\] (?P<log_level>\w+) -- : (?P<message>.*)`
	}

	stage.labels {
		values = {
			level = "",
			pid   = "",
		}
	}

	forward_to = [loki.write.staging_logs.receiver]
}

// ============================== Export ==============================
loki.write "loki_standalone" {
	endpoint {
		url     = "http://loki-sd.istore:3100/loki/api/v1/push"
		timeout = "5s"
	}
}

remotecfg {
	url = ""
}
